<h2>SLURM job arrays</h2><p>A <a data-cke-saved-href="https://slurm.schedmd.com/job_array.html" href="https://slurm.schedmd.com/job_array.html" target="_blank" title="https://slurm.schedmd.com/job_array.html" data-interception="off">SLURM job array</a> is a collection of jobs that may differ from each other by only a single index parameter. Therefore, they can be run through one submission script and Slurm will break it into multiple jobs. Slurm job arrays provide a convenient way to submit a large number of independent processing jobs</p><p>They are a useful way to run a job multiple times without having to create different submission jobs to change parameters or repeatedly submitting the same job.</p><p>Situations where job arrays are handy include:</p><ol><li>having a list of commands to run and want to run a job for each command in the list</li><li>running many parameters against one set of data</li><li>running the same program multiple times with different input data.</li></ol><p>For example, if you have a parameter that requires you to run your application five times, each with a different input parameter, you can use a job array instead of creating five separate Slur scripts and submitting them separately.</p><h3><span class="fontColorThemeSecondary">Examples</span></h3><p>For each of the situations numbered above, we will present an example below.<br>Sample scripts can be found in <span class="fontColorThemeSecondary">/stornext/System/data/apps/sample-scripts/slurm</span></p>
<h4><span class="fontColorBlue">Content on this page:</span></h4><p><a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx">SLURM job arrays</a><br><a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#examples" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#examples" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#examples">Example</a>s<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-1-if-you-have-a-list-of-commands-saved-in-cmds.txt-and-you-want-to-run-each-independently-in-one-job-submission" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-1-if-you-have-a-list-of-commands-saved-in-cmds.txt-and-you-want-to-run-each-independently-in-one-job-submission" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-1-if-you-have-a-list-of-commands-saved-in-cmds.txt-and-you-want-to-run-each-independently-in-one-job-submission">Example 1</a><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-2-if-you-have-an-analysis-program-that-you-want-to-run-multiple-times-with-different-parameters" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-2-if-you-have-an-analysis-program-that-you-want-to-run-multiple-times-with-different-parameters" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-2-if-you-have-an-analysis-program-that-you-want-to-run-multiple-times-with-different-parameters">Example 2</a><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-3-if-you-have-one-analysis-code-and-want-to-run-it-on-different-datasets" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-3-if-you-have-one-analysis-code-and-want-to-run-it-on-different-datasets" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#example-3-if-you-have-one-analysis-code-and-want-to-run-it-on-different-datasets">Example 3</a><br><a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#specifying-job-indices" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#specifying-job-indices" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#specifying-job-indices">Specifying job indices</a><br><a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#throttling-an-array-of-jobs" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#throttling-an-array-of-jobs" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#throttling-an-array-of-jobs">Throttling an array of jobs</a><br><a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#cancelling-a-job-array-or-a-sub-job" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#cancelling-a-job-array-or-a-sub-job" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#cancelling-a-job-array-or-a-sub-job">Cancelling a job array or a sub-job</a><br><a href="/sites/rc2/SitePages/SLURM-job-arrays.aspx#limitations" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#limitations" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/SLURM-job-arrays.aspx#limitations">Limitations</a></p>
<h4><span class="fontColorBlue">Example 1: </span>If you have a list of commands saved in <span class="fontColorBlue"><em>cmds.txt</em></span> and you want to run each independently in one job submission</h4><p><span class="highlightColorGrey"><span class="fontColorRed">cmds.txt</span></span></p><pre>echo "cmd1"\necho "cmd2"\necho "cmd3"\necho "cmd4" \necho "cmd5"\n</pre><p><span class="highlightColorGrey"><span class="fontColorRed">command_array.sh</span></span></p><pre>#!/bin/bash\n#SBATCH --job-name=cmd_array\n#SBATCH --ntasks=1\n#SBATCH --mem=100M\n#SBATCH --output=command_array-%A_%a.out\n#SBATCH --array=1-5\necho "Running Array Job ID="$SLURM_ARRAY_JOB_ID", Array Index="$SLURM_ARRAY_TASK_ID\ncommand=$(sed -n "$SLURM_ARRAY_TASK_ID"p cmds.txt)\nsrun $command\n</pre><p>​​​​​In the above script, we have specified a 5 element job array using <em><span class="fontColorBlue">--array=1-5</span></em></p><p>This means that this job will be executed 5 times each with a new index value ($SLURM_ARRAY_TASK_ID). This index is used in the <span class="highlightColorGrey"><span class="fontColorRed">sed</span></span> to choose the line from <em><strong>cmds.txt</strong></em> to execute using <em><span class="fontColorBlue">srun</span></em>.</p><p>To submit the script:</p><pre>sbatch command_array.slurm\nSubmitted batch job 1457494\n</pre><pre><span class="fontColorRed">squeue -u &lt;user_id&gt;</span>\n\nJOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)\n1457494_1   regular cmd_arra iskander  R       0:00      1 milton-sml-001\n1457494_2   regular cmd_arra iskander  R       0:00      1 milton-sml-001\n1457494_3   regular cmd_arra iskander  R       0:00      1 milton-sml-001\n1457494_4   regular cmd_arra iskander  R       0:00      1 milton-sml-001\n1457494_5   regular cmd_arra iskander  R       0:00      1 milton-sml-001\n</pre><p>You can see that only one array job id (<strong>$SLURM_ARRAY_JOB_ID</strong>) (1457494) is used but that job id has 5 sub-jobs being executed (1457494_1, 1457494_2, 1457494_3, 1457494_4 and 1457494_5). Consequently, you will find 5 Slurm out files created. Each <strong>*.out</strong> file will contain similar contents, depending on the array index.</p><p>For example, <span class="fontColorBlue">command_array-1457494_5.out</span> will contain the following:</p><pre>Running Array Job ID=1457494, Array Index=5\n"cmd5"</pre>
<h4><span class="fontColorBlue">Example 2:</span> If you have an analysis program that you want to run multiple times with different parameters</h4><p><span class="highlightColorGrey"><span class="fontColorRed">rseed.sh</span></span></p><p><span class="fontColorBlue">RANDOM=$1 echo $RANDOM</span></p><p>The above code is a simple random number generator that uses the first argument as the seed.</p><div class="canvasRteResponsiveTable"><div class="tableCenterAlign tableWrapper"><table style="width:781px;" class=" cke_show_border"><tbody><tr><td style="width:753px;"><span class="fontColorRed">&nbsp;&nbsp;&nbsp; <strong>Note:&nbsp;</strong>&nbsp; </span><span class="fontColorBlue">$RANDOM</span> is a special variable in bash for generating random numbers.</td></tr></tbody></table></div></div><p><br>We will use this script to generate 10 different random numbers simultaneously using Slurm with the following script. It creates a job array with 10 tasks (sub-jobs).</p><pre>```\n#!/bin/bash\n#SBATCH --job-name="rand_ar"\n#SBATCH --ntasks=1\n#SBATCH --mem=100M\n#SBATCH --array=10-20\n#SBATCH --output=rand_ar%A_%a.out\n./rseed.sh $SLURM_ARRAY_TASK_ID &gt;&gt; rand.txt\n```</pre><p>Here we used <em><span class="fontColorBlue">--array=10-20</span></em> indices instead of 1-10. You can choose any start and end index as long as it is within the limits, discussed below.&nbsp;</p><p>You can also indicate a step size. For example:<br>&nbsp;&nbsp;&nbsp; <em><span class="fontColorBlue">--array=10-20:2</span></em><br><br>This means that the jobs created will get the following indices: 10, 12, 14, 16, 18, 20.</p>
<h4><span class="fontColorBlue">Example 3:</span> If you have one analysis code and want to run it on different datasets</h4><p>If you have the following data files:</p><pre>./data/file_sample101\n\n./data/file_sample303\n\n./data/file_sample405\n</pre><p>And you want to run a script <em><strong>analysis.sh</strong></em> on each of the data files independently, so job arrays can make your life easier by running the job script multiple times and modifying the file name each time.</p><p>Put all the file names into one txt file:</p><p><span class="highlightColorGrey"><span class="fontColorRed">datafile.txt</span></span></p><pre>./data/file_sample101\n./data/data_sample303\n./data/anotherfile_sample405\n</pre><p>Then your submission script can look something like:</p><pre>#!/bin/bash \n#SBATCH --job-name=analysis_array \n#SBATCH --ntasks=1 \n#SBATCH --output=command_array-%A_%a.out \n#SBATCH --array=1-3\n#SBATCH --mem 100M\nname=$(sed -n “$SLURM_ARRAY_TASK_ID”p datafile.txt)\n./analysis.sh $name output\n</pre>
<h3><span class="fontColorThemeSecondary">Specifying job indices</span></h3><p>Job array indices can be specified in several different ways:</p><ul><li><p>using a range: &nbsp; <em><span class="fontColorBlue">#SBATCH --array=0-31</span></em></p></li><li><p>using a list of values:&nbsp; <em><span class="fontColorBlue">#SBATCH --array=1,2,5,19,27</span></em></p></li><li><p>using a range with a step size:&nbsp; <em><span class="fontColorBlue">#SBATCH --array=1-7:2</span></em></p></li></ul><h3><span class="fontColorThemeSecondary">Throttling an array of jobs</span></h3><p>If you want to create a 25-element job array and don't want them all to run at the same time, but do want only 5 jobs running at any time, you can use throttling as follows:</p><pre><span class="fontColorRed">--array=1-25%5</span>\n</pre><p>This directive with <strong><span class="fontColorBlue"><em>%5</em></span></strong> means no more than 5 of the jobs are allowed to run simultaneously.</p><pre><span class="fontColorRed">squeue -u &lt;user_id&gt;</span>\n\nJOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)\n1457571_[6-25%5]   regular cmd_arra iskander PD       0:00      1 (JobArrayTaskLimit)\n1457571_4   regular cmd_arra iskander  R       0:02      1 milton-sml-001\n1457571_5   regular cmd_arra iskander  R       0:02      1 milton-sml-001\n1457571_1   regular cmd_arra iskander  R       0:03      1 milton-sml-002\n1457571_2   regular cmd_arra iskander  R       0:03      1 milton-sml-001\n1457571_3   regular cmd_arra iskander  R       0:03      1 milton-sml-001\n</pre><h3><br><span class="fontColorThemeSecondary">Cancelling a job array or a sub-job</span></h3><p>To delete a whole job array or a sub-job, use the <span class="fontColorBlue"><em>scancel </em></span>command.</p><p>To cancel the whole job array:</p><pre><span class="fontColorRed">scancel 1457571 </span>\n</pre><p>To cancel only the 4th element:</p><pre><span class="fontColorRed">scancel 1457571_4 </span>\n</pre><h3><br><span class="fontColorThemeSecondary">Limitations</span></h3><ul><li>WEHI SLURM implementation has a maximum array size of <span class="fontColorThemeSecondary">1000</span> (MaxArraySize = 1001). That means the maximum job array you can define is <span class="fontColorBlue"><em>--array=0-1000</em></span>.&nbsp;</li><li>Using<strong><span class="fontColorThemeSecondary"> bonus qos</span></strong>, the maximum array size is decreased to <span class="fontColorThemeSecondary">500</span>.</li></ul>
<div class="canvasRteResponsiveTable"><div class="tableCenterAlign tableWrapper"><table style="width:712px;" class=" cke_show_border"><tbody><tr><td><strong><span class="fontColorRed">Note:</span> </strong></td><td style="text-align:center;width:584px;">You cannot use an index that is larger than 1000<br>i.e. you can not set <span class="fontColorBlue">--array=1000-2000</span></td></tr></tbody></table></div></div>
