<h2>Data on tape</h2><h3><span class="fontColorThemeSecondary">Archival</span></h3><p>When you are actively working on a files in a Stornext directory, that data is being created/modified <em>on disk</em>. Every night, this data is automatically <em>copied to the Stornext tape archive</em>. After this backup occurs, your data exists on <em>both the disk and tape</em>.</p><h3><span class="fontColorThemeSecondary">Truncation</span></h3><p><strong>Truncation</strong>&nbsp;is where the contents of a file (which have already been copied to tape) are removed from the disk, leaving only the file name as a link to the data.</p><p>Users create/edit files and save them on <strong><a title="/sites/rc2/SitePages/Data-how-to-store.aspx" data-interception="on" data-cke-saved-href="/sites/rc2/SitePages/Data-how-to-store.aspx" href="/sites/rc2/SitePages/Data-how-to-store.aspx">any managed system</a></strong>, and WEHI nightly backup copies all changes made&nbsp;to tape storage. When a file is no longer actively required, it should be manually removed from the managed&nbsp;storage disk by <strong>truncation.</strong></p><p>Truncation removes the file from disk storage, but retains the copy on tape storage. This frees up valuable disk space. Truncated files can still be retrieved from tape via WEHI central storage and appears on Finder/Windows Explorer as a placeholder file. You can request a <strong><a href="/sites/rc2/SitePages/Truncating-data.aspx" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Truncating-data.aspx" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Truncating-data.aspx">Truncation course</a></strong> and you can also view the <strong><a href="/sites/rc2/Shared%20Documents/Forms/AllItems.aspx?id=/sites/rc2/Shared%20Documents/Training%20courses/truncation%20training%20documentation.pdf&amp;parent=/sites/rc2/Shared%20Documents/Training%20courses&amp;p=true" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/Shared%20Documents/Forms/AllItems.aspx?id=%2Fsites%2Frc2%2FShared%20Documents%2FTraining%20courses%2Ftruncation%20training%20documentation%2Epdf&amp;parent=%2Fsites%2Frc2%2FShared%20Documents%2FTraining%20courses&amp;p=true" target="_blank" data-interception="off" title="https://wehieduau.sharepoint.com/sites/rc2/Shared%20Documents/Forms/AllItems.aspx?id=%2Fsites%2Frc2%2FShared%20Documents%2FTraining%20courses%2Ftruncation%20training%20documentation%2Epdf&amp;parent=%2Fsites%2Frc2%2FShared%20Documents%2FTraining%20courses&amp;p=true">course material</a>.</strong></p><h3><span class="fontColorThemeSecondary">Auto Truncation (AT) Policy</span></h3><p>Auto-truncation runs every night,&nbsp;it checks if the filesystem is over a certain percentage (95% usually), and if so&nbsp;it truncates files older than 90 days. In effect, this policy searches for files <em>on disk</em> that are older than 90 days and <em>removes them from disk</em>. If needed at a later time, these files need to be retrieved.</p><h3><span class="fontColorThemeSecondary">Emergency Truncation&nbsp;Policy</span></h3><p>Emergency truncation events are triggered when the volume of data being written to the filesystem exceeds the available free space,&nbsp;which may be at any time of day, and it will truncate anything - files that have been recently created or accessed.​​​​​​​</p><p><strong>Emergency truncation on Home</strong>&nbsp;may affect any or all users, leaving users unable to log in to servers, unable to run jobs, and become unproductive. Files appear as though they are there but when accessed the file needs to be retrieved from tape.&nbsp; Programs accessing truncated files may hang,&nbsp;freeze, or fail in other unexpected ways.&nbsp;&nbsp;<strong>Retrieving files from tape</strong>&nbsp;to recover from an emergency truncation event&nbsp;may take significant amounts of time:<br><br></p><ul><li>waiting for enough free space to be reclaimed on the filesystem,</li><li>competing with other retrieval requests, and</li><li>depending upon the size of the file.</li></ul>
<h3><span class="fontColorThemeSecondary">How to truncate/retrieve files?</span></h3><p>Users are encouraged to routinely truncate files to tape once they are not active, this frees up space on managed filesystems for new projects.</p><p>To truncate or retrieve your files, use stornext module in the&nbsp;<strong><a title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/modules.aspx#modules-system" data-interception="off" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/modules.aspx#modules-system" href="/sites/rc2/SitePages/modules.aspx#modules-system">Modules system</a>.</strong></p><pre>module load stornext\n\nNOTE: Always use the real path to the files and directories when using the stornext tools.\n      Use 'pwd -P' to get the physical path of files and directories.\n</pre><pre>module help  stornext\n\n----------- Module Specific Help for 'stornext/1.0' ---------------\n\nThis module provides tools to archive and retrieve files.\nIt includes the following tools:\n\n    - snfileinfo/fsfileinfo: obtains file information from the storage controller.\n                             This command allows to identify if the files are on\n                             tape and/or disk, ile size, copies available (and\n                             tape IDs), modification date, and file truncation\n                             policies\n\n    - snretrieve/fsretrieve: this command will fetch the data for a truncated for\n                             file from tape and place it on disk. File operations\n                             that return "Operation not permitted" commonly\n                             commonly happen due to truncation. The files should\n                             The files should be retrieved using this command to\n                             make them available.\n\n    - snrmdiskcopy/fstruncate: this command will truncate the file by removing\n                               the data from disk. The metadata is kept. The\n                               file will NOT be erased, as tape copies of the\n                               file must exist for the truncation to proceed.\n                               This command is useful to free space on disk\n                               and protect files.\n\nNOTE: the "fs" and "sn" commands are interchangeable (in fact they are\n      the same thing). The fs files are kept for legacy purposes.\n      Additionally, on Milton, the wehi-stornext and stornext modules load\n      the same directories and files.</pre>
<p><strong>Note that</strong> if&nbsp;you get "<span class="fontColorBlue"><em>Permission Denied</em></span>" or "<em><span class="fontColorBlue">Operation not permitted</span></em>" although the file permissions seem&nbsp;correct,&nbsp;the files may have been <strong>truncated</strong> to tape.</p>
<h4><span class="fontColorThemeSecondary">How to truncate files?</span></h4><p>If you have a file called test.txt that needs to be truncated to tape</p><pre>snrmdiskcopy -v test.txt\nJob 327550 RUNNING\nData disk blocks for file /stornext/Home/data/allstaff/i/iskander.j/test.txt were successfully removed.\n1 out of 1 disk copy removes were successful.\nCommand Successful.\n</pre><p>-v is for verbosity</p><p>Now, try to read the file and it will fail as the file is no more on disk.</p><pre>cat test.txt\ncat: test.txt: Operation not permitted</pre>
<h4><span class="fontColorThemeSecondary">How to retrieve files?</span></h4><p>To retrieve the truncated test.txt</p><pre>snretrieve test.txt\nJob 327551 READY\nJob 327551 RUNNING\nJob 327551 RUNNING\nJob 327551 RUNNING\nJob 327551 RUNNING\nJob 327551 RUNNING\nJob 327551 RUNNING\nJob 327551 COMPLETED</pre><p>Now, try to read the file and it will show file contents.</p><pre>cat test.txt</pre>
<h3><span class="fontColorThemeSecondary">Getting information about files</span></h3><p>You can use the snfileinfo &lt;files&gt; command to get information about file(s).</p><pre>snfileinfo parabricks_sample.tar.gz\nSubmitted job 400964\nJob 400964 RUNNING\nJob 400964 COMPLETED:\n-------------------------------------------------------------------------------\n File Information Report                       2023-05-31 15:42:05\n Filename:    /stornext/General/data/academic/rcp_projects/parabricks_sample.tar.gz\n Stored Name: /stornext/General/data/academic/rcp_projects/parabricks_sample.tar.gz\n-------------------------------------------------------------------------------\n      Last Modification: 05-apr-2023 15:05:54\n      Owner:             unknown            Location:        DISK AND ARCHIVE\n      Group:             unknown            Existing Copies: 2\n      Access:            644                Target Copies:   2\n                                            Expired Copies:  0\n      Target Stub:       0 (KB)             Existing Stub:   n/a (KB)\n      File size:         9,924,454,379      Store:           MINTIME\n      Affinity:          n/a                Reloc:           MINTIME\n      Class:             general_policy     Trunc:           MINTIME\n      Alt Store Copy:    Disabled           Clean DB Info:   NO\n      Media:      PC0423(1)  UB0406(2)  \n      Checksum:   N\n      Encryption: N\n      Object Ids: N</pre><p>From here, you can see the File size (in this case 9,924,454,379 bytes, or 9.2GB), and whether the file has been truncated from the "Location" field. DISK AND ARCHIVE indicates the file is stored on both the disk and tape archive. If the file is on tape only, the location will be "ARCHIVE". Similarly, if the file is yet to be backed up, the location will be "DISK".</p><h3><span class="fontColorThemeSecondary">Getting the size of truncated files using "du"</span></h3><p>Truncated files have no <em>real</em> size. However, they usually still have an <em>apparent</em> size. This size will still be visible if you use the "ls -l" command. If you wish to get the size of a directory full of truncated files, you can use "du" with the "--apparent-size" flag:</p><pre>du -sh --apparent-size .</pre><p>This will get the <em>apparent</em> size of all the files (including truncated ones) in the current working directory. "-s" asks for summary stats for the argument(s), and "-h" asks for human-readable file sizes.</p>
