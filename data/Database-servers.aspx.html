<h2>Running database servers</h2><p>It is becoming more common for advanced analyses and workflows to store data in databases such as MySQL, Mongo, etc. SQLite is a popular SQL database because of its ease of use, however, it does not scale to large amounts of data and does not support access control for multiple users. Sometimes, a fully featured database server is required for your project.</p><p>In principle, you can compile the server yourself in your home area, but this is typically several days' work and it is hard to reproduce if you have to do it again. Docker containers are a far better alternative.</p>
<h4><span class="fontColorBlue">Contents on this page:</span></h4><p><a href="/sites/rc2/SitePages/Database-servers.aspx#running-database-servers" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#running-database-servers" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#running-database-servers">Running database servers</a><br><a href="/sites/rc2/SitePages/Database-servers.aspx#where-should-you-run-the-server" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#where-should-you-run-the-server" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#where-should-you-run-the-server">Where should you run the server?</a><br><a href="/sites/rc2/SitePages/Database-servers.aspx#mysql" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#mysql" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#mysql">MySQL</a><br><a href="/sites/rc2/SitePages/Database-servers.aspx#connecting-to-mysql-server-remotely" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#connecting-to-mysql-server-remotely" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#connecting-to-mysql-server-remotely">Connecting to MySQL server remotely</a><br><a href="/sites/rc2/SitePages/Database-servers.aspx#mongodb" data-cke-saved-href="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#mongodb" data-interception="on" title="https://wehieduau.sharepoint.com/sites/rc2/SitePages/Database-servers.aspx#mongodb">MongoDB</a></p>
<p>The entire software stack required to run the server is in the container. Furthermore, you can run containers at WEHI using singularity without special privileges.</p><p>Singularity is available through the WEHI module system.</p><pre>module load singularity/3.6.2\n</pre><p>This guide explains how to start servers using Singularity at WEHI. It offers no advice on setting up access controls, structuring, loading, or querying your data.</p><h3><span class="fontColorThemeSecondary">Where should you run the server?</span></h3><p>If the server is not under load, run it in a shared resource such as vc7-shared. If the server is under load, for example during bulk data loading, consider running it in the batch system.</p><p><span class="fontColorRed"><strong>Note:</strong></span> However you run the server, be aware that some database servers do not handle abrupt shutdowns and may corrupt their databases storage areas. If running in the batch system, you will need a mechanism to shut down the server. Allowing the job to run out of walltime or killing the batch job does not allow the server to shut down cleanly. Also, be careful not to start more than one copy of the server as this may lead to database corruption.</p>
<h2>MySQL</h2><h3><br><span class="fontColorBlueLight">Running and connecting to MySQL server locally</span></h3>
<p style="margin-left:40px;"><span class="fontColorYellowLight">1. </span>Load the required modules</p><pre style="margin-left:40px;">$ module load apptainer/1.1.0\n$ apptainer pull mysql.sif docker://mysql \n</pre><p style="margin-left:40px;"><span class="fontColorYellowLight">2.</span> In your home area create two files</p><pre style="margin-left:40px;">$ touch .my.cnf     \n$ touch .mysqlrootpw \n</pre><p style="margin-left:40px;"><span class="fontColorYellowLight">3.</span> Then modify the files</p><pre style="margin-left:40px;">$ nano .my.cnf \n</pre><p style="margin-left:40px;">Add the following contents</p><pre style="margin-left:40px;">[mysqld]\ninnodb_use_native_aio=0 \ninit-file=${HOME}/.mysqlrootpw \nport=59999 \n\n[client] \nuser=root \npassword='my-secret-pw' \n</pre><p style="margin-left:40px;">You can change the password and the port as you wish, but make sure the port is in the range 49152-65535 to reduce the risk of conflicting with servers that other users may be running.</p><pre style="margin-left:40px;">$nano . mysqlrootpw \n</pre><p style="margin-left:40px;">Add the following contents</p><pre style="margin-left:40px;">SET PASSWORD FOR 'root'@'localhost' = PASSWORD('my-secret-pw');</pre><p style="margin-left:40px;"><span class="fontColorYellowLight">4a. </span>Create local directories for MySQL. These will be bind-mounted into the container and allow other containers to connect to the database via a local socket.</p>
<p style="margin-left:40px;"><span class="fontColorYellowLight">4b.</span> The database will aslo&nbsp;be stored on the host filesystem and thus persist between container instances.</p><pre style="margin-left:40px;">$ mkdir -p ${PWD}/mysql/var/lib/mysql ${PWD}/mysql/run/mysqld </pre><p style="margin-left:40px;"><span class="fontColorYellowLight">5.</span> Start the singularity instance</p><pre style="margin-left:40px;">$singularity instance start --bind ${HOME} --bind ${TMPDIR} --bind ${PWD}/mysql/var/lib/mysql/:/var/lib/mysql --bind ${PWD}/mysql/run/mysqld:/run/mysqld ./mysql.simg mysql\n</pre><p style="margin-left:40px;"><span class="fontColorYellowLight">6. </span>Run the container start script to initialise and start the MySQL server. Note that initialisation is only done the first time and the script will automatically skip initialisation if it is not needed. This command must be run each time the MySQL server is needed (e.g., each time the container is spun-up to provide the MySQL server).</p><pre style="margin-left:40px;">$ singularity run instance://mysql \n</pre><p style="margin-left:40px;"><span class="fontColorYellowLight">7.</span> To connect through socket</p><pre style="margin-left:40px;">$ mysql -S ${PWD}/mysql/run/mysqld/mysqld.sock \n</pre><p style="margin-left:40px;">Or through tcp</p><pre style="margin-left:40px;">$ mysql -h 127.0.0.1 -P 59999 \n</pre><p style="margin-left:40px;"><span class="fontColorYellowLight">8.</span> When done, stop the MySQL container instance.</p><pre style="margin-left:40px;">$ singularity instance stop mysql </pre><p>You can use the WEHI system <span class="fontColorBlueLight"><em>mysql</em></span> command as a client for command-line access. Other software or programming languages typically need adaptor libraries or modules. Refer to the documentation for the software or language.</p>
<h3><span class="fontColorThemeSecondary">Connecting to MySQL server remotely</span></h3><p>Commonly you might run your server in <span class="fontColorBlue"><em>vc7-shared</em></span> and connect to it through your SLURM batch jobs. In addition, if the server is under load, you might need to consider running it in the batch system.</p><p>In either case, you need to know the IP &lt;x.x.x.x&gt; or hostname of the compute node where the MySQL server is. The above steps are still valid but you need to do some additional steps as follows:<br><br></p><ol><li><p>Modify .my.cnf</p><pre><span class="fontSizeMedium">[mysqld] \ninnodb_use_native_aio=0 \ninit-file=${HOME}/.mysqlrootpw \nport=59999 \nbind-address = 0.0.0.0 \n\n[client] \nuser=root \npassword='my-secret-pw' </span>\n\n</pre></li><li><p>Create MySQL users</p><p><strong>Make sure</strong> the instance is running before executing the cmd.</p><pre><span class="fontSizeMedium">$ singularity exec instance://mysql create_remote_admin_user.sh </span>\n</pre><p>This will create a MySQL user and password and will show a message similar to</p><pre><span class="fontSizeMedium">Random password for remote user 'remote_usr': u-eoe8PP </span>\n</pre><p>where the created username is <em><span class="fontColorBlue">remote_usr</span></em> and the password is <em><span class="fontColorBlue">u-eoe8PP</span></em>.<br><br></p></li><li><p>Connect to MySQL</p><pre><span class="fontSizeMedium">$ mysql -h 127.0.0.1 -P 59999 -u remote_usr -pu-eoe8PP </span>\n</pre><p>Replace <span class="fontColorBlue"><em>127.0.0.1</em></span> with the hostname or IP address of the node where the singularity image is running.<br><br><strong>​​​​​​​Make sure </strong>there is no space between <em><span class="fontColorBlue">-p</span></em> and the password.</p></li></ol>
<h2>MongoDB</h2><p>Download the docker container:</p><pre>singularity pull docker://mongo\n</pre><p>This creates a file called <em><span class="fontColorBlue">mongo_latest.sif</span></em> in the current directory.</p><p>Start the server as follows:</p><pre>singularity run --bind &lt;path to your data directory&gt;:/data/db mongo_latest.sif [options]\n</pre><p><br>Refer to the MongoDB documentation for options. At a minimum, you should probably run with authentication enabled.</p><p>You can start a command-line client as follows:</p><pre>singularity run --bind $MONGO_HOME/data:/data/db $MONGO_HOME/mongo_latest.sif mongo [options]\n</pre><p><br>There are bindings for many popular programming languages, refer to the <a href="https://docs.mongodb.com/" data-cke-saved-href="https://docs.mongodb.com/" target="_blank" data-interception="off" title="https://docs.mongodb.com/">MongoDB documentation</a>&nbsp;for more information.</p>
