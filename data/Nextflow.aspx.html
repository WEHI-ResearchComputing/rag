<h4 style="margin-left:0px;"><span class="fontColorBlue"><strong>Contents on this page:</strong></span></h4><ul><li><a href="#requirements">Requirements</a></li><li><a href="#accessing-nextflow">Accessing Nextflow</a></li><li><a href="#configuring-nextflow">Configuring Nextflow</a></li><li><a href="#process-dependencies">Process Dependencies</a></li><li><a href="#data-management">Data Management</a></li><li><a href="#nextflow-tower">Nextflow Tower</a></li><li><a href="#github-credentials">GitHub Credentials</a></li><li><a href="#troubleshooting">Troubleshooting</a></li></ul>
<h2><span class="fontColorThemeSecondary">Requirements</span></h2><p>To use Nextflow on Milton, you must have successfully applied for <a href="/sites/rc2/SitePages/high-performance-storage.aspx#using-the-scratch-filesystem">VAST Scratch</a>. If you haven't done so already, you can easily apply <a href="https://support.wehi.edu.au/support/catalog/items/71">using this form</a>.</p><h2><span class="fontColorThemeSecondary">Accessing Nextflow</span></h2><p>Nextflow is available as a module on Milton. To access it, run module load nextflow. You will then be able to run the nextflow command to run pipelines.</p><h2><span class="fontColorThemeSecondary">Configuring Nextflow</span></h2><p>Running Milton's Nextflow will automatically create a config file at ~/.nextflow/config suited to running on Milton. However, you can adjust it as necessary, using the <a href="https://www.nextflow.io/docs/latest/config.html#configuration">Nextflow documentation</a> as a reference.</p><p>Also note that it is possible <i>and recommended</i> to specify configuration per-workflow, instead of setting it all in your global nextflow configuration file. For information on doing this, please refer to <a href="https://www.nextflow.io/docs/latest/config.html#configuration-file">this part of the documentation</a>.</p><h2><span class="fontColorThemeSecondary">Process Dependencies</span></h2><p>Nextflow supports many ways to load dependencies for your Nextflow processes. Most of the time these dependencies will be command-line tools like bwa that you want to run inside Nextflow. Sometimes they will be language runtimes like R or python.</p><p>On Milton, we suggest using any of these three mechanisms, each of which have advantages and disadvantages:</p><ul><li>Modules</li><li>Containers</li><li>Conda</li></ul><h3><span class="fontColorThemeSecondary">Using Containers</span></h3><p>The advantages of using containers are:</p><ul><li>Reproducibility: other users of your pipeline will use the exact same versions, even if they are running your pipeline on another machine or HPC system</li><li>Portability: this will allow your workflow to seamlessly run on other platforms entirely, such as cloud</li><li>Speed: downloading containers is generally faster than installing conda packages</li></ul><p>The disadvantages of using containers are:</p><ul><li>Storage. Containers take up a moderate amount of space. Because of this, Nextflow containers on Milton are automatically stored in VAST Scratch, meaning that they are cleaned up every 2 weeks.</li></ul><p>To find an appropriate container with the software you need, consider searching through:</p><ul><li><a href="https://biocontainers.pro/registry">The BioContainers registry</a></li><li><a href="https://hub.docker.com/search?">Docker Hub</a></li></ul><p>Once you've found a container you want, you can tell Nextflow to use it using the <a href="https://www.nextflow.io/docs/latest/process.html#container">container directive</a>:</p><pre>container "quay.io/biocontainers/bwa:0.7.17--ha92aebf_3"\n</pre><h3><span class="fontColorThemeSecondary">Using Conda</span></h3><p>To learn about using Conda with Nextflow, please refer to the <a href="https://www.nextflow.io/docs/latest/conda.html">corresponding section of the official Nextflow documentation</a>.</p><p>The advantages of using conda are:</p><ul><li>Reproducibility: other users of your pipeline will use the exact same versions, even if they are running your pipeline on another machine or HPC system</li></ul><p>The main disadvantages of using conda are:</p><ul><li>Speed: solving conda environments can be quite slow</li><li>Storage: conda packages can take up a large amount of space</li></ul><p>To use conda in your workflow, you should annotate each of your processes with a list of conda packages that it needs, <a href="https://www.nextflow.io/docs/latest/process.html#conda">as described here</a>:</p><pre>  conda 'bwa=0.7.15'\n</pre><p>To enable conda, you must remember to set conda.enabled = true in the <a href="https://www.nextflow.io/docs/latest/config.html#configuration-file">nextflow config file</a> for your pipeline. You will likely also want to change the following settings:</p><ul><li>conda.cacheDir: set this to a location in VAST scratch to ensure Nextflow doesn't clog up your home directory</li><li>conda.useMicromamba: setting this to true will make installing environments much faster, but you will have to remember to run module load micromamba before running any pipelines that use this option</li></ul><p>A full list of conda related configuration options <a href="https://www.nextflow.io/docs/latest/config.html#config-conda">can be found here</a>.</p><h3><span class="fontColorThemeSecondary">Using Modules</span></h3><p>To learn about using modules with Nextflow, please refer to the <a href="https://www.nextflow.io/docs/latest/process.html#module">corresponding section of the official Nextflow documentation</a>.</p><p>To use modules in your workflow, annotate each process with a list of modules that it needs:</p><pre>  module 'bwa/0.7.13'\n</pre><p>The main advantage of using modules to load dependencies with Nextflow is that the software is already installed on Milton. This means:</p><ul><li>Speed: there is no wait time to install software</li><li>Storage: you do not need to use additional parts of your disk quota to access software in this way</li></ul><p>The main disadvantages of using modules are:</p><ul><li>Portability: your pipeline will only work on HPC, and only then if the HPC system has the exact same modules that you have loaded</li><li>Reproducibility: even if your runtime HPC has the same modules as Milton, there will likely be small differences in how it was installed, or how the system is configured, which may result in different pipeline results</li></ul><h2><span class="fontColorThemeSecondary">Data Management</span></h2><p>Nextflow on Milton uses the VAST Scratch filesystem to process files. You can verify this by printing the $NXF_WORK environment variable:</p><pre>$ echo $NXF_WORK\n/vast/scratch/users/milton.m/nextflow/work\n</pre><p>This is advantageous because of the speed and capacity of the scratch filesystem, but it does mean that you will have to have a strategy for handling the 2-week cleanup time that VAST Scratch is subject to. This means that, every 2 weeks, all the intermediate and temporary files used by your pipeline will be deleted, at which point you will be unable to -resume the pipeline, and you will have to re-run it from the start. This cleanup will not affect your input files, however, which should be in another filesystem such as your home directory or lab share.</p><p>For your output files, one strategy you might consider is using the <a href="https://www.nextflow.io/docs/latest/process.html#publishdir">publishDir directive</a> to copy results out of your pipeline and into a longer term file system, such as your home directory or lab share. For example, the following invocation would copy the outputs of a process into a directory called results in your home:</p><pre>publishDir '/home/users/allstaff/&lt;YOUR USERNAME&gt;/results', mode: 'copy', overwrite: false\n</pre><h2><span class="fontColorThemeSecondary">Nextflow Tower</span></h2><p>If you want a graphical interface for running and monitoring (but not creating) workflows, please consider using the free Nextflow Tower service available at WEHI. <a href="/sites/rc2/SitePages/Nextflow-Tower.aspx">For more information, visit this page</a>.</p><h2><span class="fontColorThemeSecondary">GitHub Credentials</span></h2><p>You may encounter a GitHub API error when running Nextflow pipelines from GitHub (for example nf-core pipelines):</p><pre>API rate limit exceeded -- Provide your GitHub user name and password to get a higher rate limit</pre><p>You can resolve this issue using a GitHub API token:</p><ul><li>Create a new access token <a href="https://github.com/settings/tokens/new">by visiting this page</a>. You do not need to check any boxes if you are only accesssing public repositories. If you need to pull from a private repository, you will need to check the repo box.</li><li>Record the generated API token before closing the GitHub page</li><li>Create a <a href="https://www.nextflow.io/docs/latest/sharing.html#scm-configuration-file">Nextflow SCM file</a>&nbsp;by editing ~/.nextflow/scm with a text editor on the Milton HPC (or whichever machine you are running Nextflow from)</li><li>Into this file, paste the following, replacing the placeholder values as appropriate:</li></ul><pre>providers {\n    github {\n&nbsp;       user = '&lt;YOUR GITHUB USERNAME&gt;'\n&nbsp;       password = '&lt;YOUR PERSONAL ACCESS TOKEN&gt;'\n&nbsp;   }\n}</pre><h2><span class="fontColorThemeSecondary">Troubleshooting</span></h2><p>If your nextflow pipeline fails to complete, you can investigate the cause using the <i>nextflow log</i> command.</p><h4><span class="fontColorThemeSecondary">1.Find the Run Name</span></h4><p>To find the run name, first run <i>nextflow log </i>with no arguments. You might already know this since nextflow prints this out when you start the pipeline.&nbsp;</p><pre>$ nextflow log<br>TIMESTAMP               DURATION        RUN NAME        STATUS  REVISION ID     SESSION ID                              COMMAND<br>2023-10-03 11:34:17     2m 50s          reverent_morse  ERR     c824b62258      f6182aa0-7b81-4625-8f3c-6ab47aafa937    /stornext/System/data/tools/nextflow/nextflow-22.10.4/nextflow-22.10.4-all run main.nf<br>2023-10-03 11:37:36     21.1s           stupefied_knuth OK      d6ef825a5c      816005af-22b2-423e-9c57-59448a353216    /stornext/System/data/tools/nextflow/nextflow-22.10.4/nextflow-22.10.4-all run main.nf</pre><p>In the above example, the run name we want is “reverent_morse”, since it corresponds to the workflow run with status “ERR”, ie the one that failed.</p><h4><span class="fontColorThemeSecondary">2.Find the Working Directory</span></h4><p>Using the run name, we can query nextflow for all the failed jobs using <i>nextflow log &lt;jobname&gt;:</i></p><pre>$ nextflow log chaotic_watson -filter 'status == "FAILED"' -fields name,workdir<br>use_memory      /vast/scratch/users/milton.m/nextflow/work/ba/bf3140a91cb5c4916227777e7e9cd4</pre><p>This specific command gives us the working directory that corresponds to each failed process, for example <i>/vast/scratch/users/milton.m/nextflow/work/ba/bf3140a91cb5c4916227777e7e9cd4.</i></p><h4><span class="fontColorThemeSecondary">3.Investigate the Process Outputs</span></h4><p>Using the working directory found in the previous step, first move into this directory, then read the following files:</p><ul><li>.command.err</li><li>.command.out</li></ul><p>For example, we might run the following:</p><pre>$ cd /vast/scratch/users/milton.m/nextflow/work/ba/bf3140a91cb5c4916227777e7e9cd4<br>$ cat .command.err<br>/var/spool/slurmd/job13815104/slurm_script: line 120: 83254 Killed                  /stornext/System/data/apps/R/R-4.3.0/lib64/R/bin/Rscript /vast/scratch/users/milton.m/nextflow/work/ba/bf3140a91cb5c4916227777e7e9cd4/.command.sh </pre><p>In this example, the keywords “slurm_script” and “Killed” suggest to us that Slurm has killed the job.&nbsp;</p><h4><span class="fontColorThemeSecondary">4a.Query Slurm</span></h4><p>Since Slurm was the culprit, we can request more information from it using sacct and the job ID shown in the log:</p><pre>$ sacct --jobs 13815104<br>JobID           JobName  Partition    Account  AllocCPUS      State ExitCode<br>------------ ---------- ---------- ---------- ---------- ---------- --------<br>13815104     nf-use_me+    regular       wehi          2 OUT_OF_ME+    0:125<br>13815104.ba+      batch                  wehi          2 OUT_OF_ME+    0:125<br>13815104.ex+     extern                  wehi          2 OUT_OF_ME+    0:125</pre><p>In this case the State being OUT_OF_MEM means that we have not requested sufficient memory. To resolve this, we need to increase the memory we requested using the “use_memory” process's memory directive. For more information on this, <a href="https://www.nextflow.io/docs/latest/process.html#memory">refer to the documentation here</a>. Since Slurm was the culprit.</p>
