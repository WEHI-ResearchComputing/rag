<h2><span class="fontColorThemeSecondary">Running Docker and Apptainer images</span></h2><p>​An increasingly popular mechanism for distributing complex software is to encapsulate the software, its dependencies and execution environment in a self-contained package. This container can then be easily distributed and executed in other environments. This has the important advantage that the software execution is independent of the environment where it is executed from which significantly enhances reproducibility.</p><ul></ul>
<p><a href="https://www.docker.com" data-cke-saved-href="https://www.docker.com" target="_blank" data-interception="off" title="https://www.docker.com">Docker</a> is currently one of the most popular container environments, and because of the significant convenience for both developers and users is being increasingly adopted by the bioinformatics community.</p><p>A major disadvantage of Docker is that it needs to run with root (i.e. admin) authority. It seems to have been designed for outward-facing enterprise applications managed by an operations team where this is not an issue. It is not suitable for an inward-facing, multi-tenanted environment, such as an HPC facility, where all user images will have root access. Running Docker images on the HPC would mean that they have to be isolated from the rest of the environment and would not be able to access the file system amongst other restrictions.</p>
<p>Other container solutions exist that overcome this limitation.</p><p>These include:</p><ul><li><a href="https://www.nersc.gov/research-and-development/user-defined-images/" data-cke-saved-href="https://www.nersc.gov/research-and-development/user-defined-images/" target="_blank" title="https://www.nersc.gov/research-and-development/user-defined-images/" data-interception="off">Shifter</a></li><li><a href="https://apptainer.org/" data-cke-saved-href="https://apptainer.org/" data-interception="on" title="https://apptainer.org/">Apptainer</a><br><a href="https://www.sylabs.io/docs/" data-cke-saved-href="https://www.sylabs.io/docs/" target="_blank" title="https://www.sylabs.io/docs/" data-interception="off">​​​​​​</a></li></ul><p>Initial evaluation has shown that Apptainer is significantly easier to build, install and run.</p>
<h3><span class="fontColorThemeSecondary">Apptainer vs Docker</span></h3><ol><li>Apptainer and Docker images are not the same. However, Apptainer can pull and use Docker images directly from Docker repositories.</li><li>By default, running Apptainer containers are read-only, i.e. the contained file system cannot be updated (this behaviour can be changed with flags).</li></ol><h3><span class="fontColorThemeSecondary">Running on Milton</span></h3><p>Apptainer is provided as a module:</p><pre>$ module load apptainer\n$ apptainer --version\napptainer version 1.0.0\n</pre><h4><span class="fontColorThemeSecondary">Pull a Docker container</span></h4><p>Docker containers can be pulled from Docker hub and converted into an Apptainer container:</p><pre>apptainer pull docker://ubuntu:20.04\n</pre><p>This creates a container with the file name "ubuntu_20.04.sif". Other registries can be pulled from, for example from Singularity hub:</p><pre>apptainer pull shub://vsoch/hello-world</pre><p>which creates the hello-world.sif container in the current directory.</p><p>If you have a Docker image or a Docker container recipe that you would like help to convert into a Apptainer container, please contact the <a href="mailto:research.computing@wehi.edu.au" data-cke-saved-href="mailto:research.computing@wehi.edu.au" data-interception="off" title="mailto:research.computing@wehi.edu.au">Research Computing team</a> or <a href="mailto:support@wehi.edu.au" data-cke-saved-href="mailto:support@wehi.edu.au" data-interception="off" title="mailto:support@wehi.edu.au">Helpdesk</a>.</p><h4><span class="fontColorThemeSecondary">Running a container or executing commands inside a container</span></h4><p>The "apptainer run" command is used to execute a run script that comes with the container. The general basic usage of the command is:</p><pre>apptainer run &lt;container&gt; &lt;arguments&gt;</pre><p>In some cases, the run script will execute without the need for additional arguments. For example,</p><pre>$ apptainer run hello-world_latest.sif\n\nRaawwWWWWWRRRR!! Avocado!\n</pre><p>Often, containers will not come with a specific run-script and interpret the arguments supplied as commands. For example:</p><pre>$ apptainer run ubuntu_20.04.sif cat /etc/os-release\nNAME="Ubuntu"\nVERSION="20.04.5 LTS (Focal Fossa)"\n...\n</pre><p>which runs the "cat" command and passes the "/etc/os-release" file to query the operating system inside the container. On the other hand, if you wish to execute a shell command inside the container without executing the runscript, you can use:</p><pre>$ apptainer exec &lt;container&gt; &lt;command&gt; &lt;arguments&gt;</pre><p>which executes &lt;command&gt; inside the container and bypasses the runscript (if any).</p><p>Besides executing one-off commands using apptainer run or exec, you can also interactively execute commands inside the container by using</p><pre>$ apptainer shell &lt;container&gt;</pre><p>which starts a shell inside the container environment which you can use to explore the inside of the container or execute a collection of commands.</p><h4><span class="fontColorThemeSecondary">Mounting host directories in the container</span></h4><p>Containers have a filesystem that is mostly isolated from the host filesystem that it is contained within. But in many container use-cases, containers require input files that exist on the host system or needs to write output files to somewhere else on the host filesystem. By default, only the executing user's home directory will be visible to the container. To make additional directories on the host filesystem visible to the container, you must pass the&nbsp;<em><span class="fontColorBlue">-B</span></em> option followed by the directory to mount (source), a colon (:), and the directory to mount it as inside the container (the target). i.e.</p><pre>$ apptainer run -B hostdir:containerdir container.sif arg1 arg2 ...\n</pre><p>For example:</p><pre>$ apptainer run -B $HOME/data:/data -B $HOME/results:/results rlupat_seqliner_v0.3.9-2016-10-25-44de53b062ad.img seqliner run exome_somatic_fastq -r hg19,exome -o /results/TestOut Tumour-Fastq-Dir Normal-Fastq-Dir</pre><p>This command:</p><ul><li>runs the container "rlupat_seqliner_v0.3.9-2016-10-25-44de53b062ad.img",</li><li>executes the "seqliner" command with additional arguments,</li><li>mounts $HOME/data inside the container which is visible as /data, and</li><li>mounts $HOME/result inside the container which is visible as /results.</li></ul><p>You can also mount directories to copy files from inside the container to the host filesystem:</p><pre>apptainer exec -B $(pwd) container.sif cp file-to-copy.tar $(pwd)</pre><p>This copies the "file-to-copy.tar" file inside the container to the current working directory which has been made visible to the container using the -B option.</p><p>The -B option is available to apptainer exec, run, or shell commands.</p><h2><span class="fontColorThemeSecondary">Building an Apptainer</span><span class="fontColorThemeSecondary"> container</span></h2><p>Until the recent Apptainer update (1.1.0), Apptainer containers were best built on a computer on which you have root access. The new update enables non-priveledged Apptainer builds without introducing a security risk. If you have written an Apptainer recipe, you can build it on Milton with</p><pre>$ apptainer build --fakeroot container.sif container-recipe.def</pre><p>If you need help building a container or writing a container recipe, please contact the <a title="mailto:research.computing@wehi.edu.au" data-interception="off" data-cke-saved-href="mailto:research.computing@wehi.edu.au" href="mailto:research.computing@wehi.edu.au">Research Computing team</a> or <a title="mailto:support@wehi.edu.au" data-interception="off" data-cke-saved-href="mailto:support@wehi.edu.au" href="mailto:support@wehi.edu.au">Helpdesk</a>.</p><h2><span class="fontColorThemeSecondary">Redirecting Apptainer temporary files and cached containers</span></h2><p>Apptainer has two environment variables which control where temporary files and cached containers are written to. Temporary files are written to wherever the APPTAINER_TMPDIR environment variable is pointed to, and likewise with APPTAINER_CACHEDIR and cache files. It is important to set these directories to somewhere on VAST scratch. This is because by default, temporary files are written to the local /tmp, and cached containers are written to your home directory. Both of these directories have limited space. Add the following code to your .bashrc file in your home directory:</p><pre>export APPTAINER_TMPDIR=/vast/scratch/users/$USER/tmp\nexport APPTAINER_CACHEDIR=/vast/scratch/users/$USER/scache\n[ ! -d $APPTAINER_TMPDIR ] &amp;&amp; mkdir $APPTAINER_TMPDIR # creates the tmp folder on vast scratch if it doesn't exist\n[ ! -d $APPTAINER_CACHEDIR ] &amp;&amp; mkdir $APPTAINER_CACHEDIR # same as above, except for cached containers\n</pre><p>Note that if you are using the Apptainer predecessor, Singularity, the equivalents to the above environment variables are SINGULARITY_TMPDIR and SINGULARITY_CACHEDIR.</p><h2><span class="fontColorThemeSecondary">Final note</span></h2><p>Singularity and container technology support at WEHI is very much a work in progress at the moment.</p><p>Please report experiences and problems to the <a href="mailto:research.computing@wehi.edu.au" data-cke-saved-href="mailto:research.computing@wehi.edu.au" target="_blank" data-interception="off" title="mailto:research.computing@wehi.edu.au">Research Computing team</a> or <a href="mailto:support@wehi.edu.au" data-cke-saved-href="mailto:support@wehi.edu.au" target="_blank" data-interception="off" title="mailto:support@wehi.edu.au">Helpdesk</a>.</p>
