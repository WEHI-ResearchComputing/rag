<h2>Micrograph Compressions</h2><h3><span class="fontColorThemeSecondary">Converting mrc files to tif files</span></h3><p>This guide will help you convert/compress your mrc files into tif files. This step can reduce your raw dataset size by 5-6 times, so it will help save disk space and reduce I/O loads.<br><br></p><h3><span class="fontColorThemeSecondary">Using relion_convert_to_tiff</span></h3><p>To compress your images, you can use the following command which is single threaded and will compress one movie at a time, sequentially.</p><pre>relion_convert_to_tiff --i movies.star --o Converted/\n</pre><p><br>This will create a folder called <span class="fontColorBlue"><em>Converted</em></span> in the current directory where the compressed tif files will be saved.</p><p><em><span class="fontColorBlue">relion_convert_to_tiff</span></em> does not support thread parallelisation to compress one movie with many cores. However, MPI parallelisation can process many movies simultaneously, as follows:</p><pre>mpirun -np 24 relion_convert_to_tiff_mpi --i movies.star --o Converted/ # 24 processes\n</pre><p><br>For more information about options and gain estimation, go to <a data-cke-saved-href="https://relion.readthedocs.io/en/latest/Reference/MovieCompression.html" href="https://relion.readthedocs.io/en/latest/Reference/MovieCompression.html" target="_blank" title="https://relion.readthedocs.io/en/latest/Reference/MovieCompression.html" data-interception="off">Relion Movie Compression</a>.<br><br></p><h3><span class="fontColorThemeSecondary">Validation</span></h3><p>After compression, you need to validate that the compressed files are valid movies. This can be done using EMAN:</p><pre>module load EMAN\ne2iminfo.py image.tiff\n</pre><p>Replace <em><span class="fontColorBlue">image.tiff</span></em> with the image you need to validate. The result will be similar to the following:</p><pre>image.tiff\t 38 images in TIFF format \t7420 x 7676\n38 total images\nrepresenting 0 particles\n</pre><p>You can also use <em><span class="fontColorBlue">e2display.py</span></em> to display the image. An alternative solution is to use Relion:</p><pre>relion_image_handler --I image.tiff —stats\n</pre><p>This will calculate per-image statistics.</p><p>A script that automates validating all compressed files, can be found in the <em><span class="fontColorBlue">rc-tools</span></em> module</p><pre>module load rc-tools\nrelion_chkcompression -r starfile -c compressedpath\n</pre><p>This script checks that all files are non-zero bytes and have multiple frames, otherwise error messages are printed. It also checks that the number of tif files found in the <em><span class="fontColorBlue">compressedpath</span></em> is equal to the number of mrc files stated in the *.star file provided <em><span class="fontColorBlue">starfile.</span></em></p><p><em><span class="fontColorBlue">starfile</span></em> is the *.star file path, and <em><span class="fontColorBlue">compressedpath</span></em> is the directory path where all the compressed files were saved.</p><p>An example of a slurm submission job that compresses then validates can be found here:</p><pre>/stornext/System/data/apps/sample-scripts/cryoem/relion/convert_mrc_to_tiff.slurm</pre><blockquote><p><span class="fontColorRed"><em><strong>Notes:</strong></em></span> <span class="fontColorThemeSecondary">You should change the walltime and the amount of resources requested according to the size of your dataset.</span></p></blockquote><pre>#!/bin/bash\n\n#SBATCH --partition=regular\n#SBATCH --job-name=mrc_compress\n#SBATCH --output=%x_%j.out\n#SBATCH --error=%x_%j.err\n#SBATCH --mem-per-cpu=100M\n#SBATCH --nodes=4\n#SBATCH --ntasks-per-node=25\n#SBATCH --time=5:00:00\n\n## Change number of nodes and ntasks-per-node \n## according to number of mrc files to be compressed\n\nmodule purge\nmodule load relion/3.1.3-cu11.2<br>​​​​​​​module load rc-tools\n\n##Change this directory, to your project directory\nPROJECT_PATH='/stornext/Projects/cryoEM/cryoEM_scratch/....'\n\n##Change this directory, to where the star file is in the project directory\nmrcpath=./Import/job001/movies_temp.star\n\n##Change this directory, to the name of the folder in the project directory where the tif files will be saved\noutputpath=./compressed_$SLURM_JOBID\n\n##Go to the project directory\ncd $PROJECT_PATH\n\n​​​​​​​##Create output dir\nmkdir $outputpath\n\n##Run compression command\necho "Compressing ........."\nsrun -n $SLURM_NTASKS_PER_NODE --mem-per-cpu=$SLURM_MEM_PER_CPU relion_convert_to_tiff_mpi --i $mrcpath --o $outputpath\n\n##RUN Check on output folder\n##Check non-zero files and \necho "Running Compression Check ......"\nrelion_chkcompression -r $mrcpath -c $outputpath\n\necho "Done"\n</pre>
