<h2>What is Conda?</h2><p>Conda is one of the many package managers available for users on Mac, Windows, and Linux computers. It's probably most often used for its Python packages, but it also contains many R (CRAN and bioconductor), and system packages. It's well-loved by the scientific community because of its commitment to open-source, no cost, and rich package ecosystem.</p>
<h3>How Do I Get Started Using Conda on Milton?</h3><p>On Milton, we have the miniconda3 module which contains the conda command for you to use.</p><pre>$ module load miniconda3/latest<br>$ conda --version<br>conda 23.5.0</pre><p>This module is a shared installation, so you cannot write to the install directory. This means that <strong>to install the packages you need, you must create a new conda environment</strong>. Below are commands you will probably need to get started. But you may also find the <a href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba quickstart docs</a> and <a href="https://docs.conda.io/projects/conda/en/latest/_downloads/843d9e0198f2a193a3484886fa28163c/conda-cheatsheet.pdf">conda cheatsheet</a> useful.&nbsp;</p><h3>Micromamba vs conda</h3><p>In addition to the miniconda3 module, we also have the <span class="fontColorBlue">micromamba</span> module. <span class="fontColorBlue">Micromamba</span> is a <strong>lightweight version</strong> of the mamba tool, which is a <strong>faster implementation of the conda package manager</strong>. In nearly all cases, it is a drop-in replacement for conda and can be used interchangeably. See <a href="https://www.anaconda.com/blog/a-faster-conda-for-a-growing-community">the mamba announcement post</a> and <a href="/sites/RCPNewsletter/SitePages/April-2023-Issue.aspx#use-tech">our comparison</a> to understand the difference in install speeds.&nbsp;</p><p><strong>We recommend using the micromamba module. </strong>But also note that there are differences between (micro)mamba and conda, particularly with the config commands. The instructions below assume micromamba is being used.</p><pre>$ module load micromamba/latest<br>$ micromamba --version<br>1.5.0</pre>
<h2>Recommended configuration</h2><p>Before you go and create your conda environments and install your packages, it's important to configure conda/micromamba correctly. The challenge lies mostly with the fact that micromamba, by default, stores environments and downloaded packages into your home directory; and that, on Milton, home directories have default quotas of 20GB per person. If you're downloading lots of packages and creating many environments, you'll likely fill up your home directory pretty quickly! Below are optional configurations you can setup to avoid this.</p><p><strong>Note that</strong> both (micro)mamba and conda use the same ~/.condarc configuration file and it is shared and editable by both.</p><h4>Adding Channels</h4><p>Channels determine from which repository your packages come from. For example, the bioconda channel contains packages that are often used in health sciences, whereas the defaults and conda-forge channels provide “general” packages. micromamba doesn't have any channels configured by default, so you need to set at least conda-forge or defaults. Do this with:</p><pre>micromamba config prepend channels conda-forge</pre><p>Note that conda-forge and defaults channels largely provide the same packages. The differences stem mostly from the fact that conda-forge is community driven, whereas the defaults channel is maintained by Anaconda inc. This results in conda-forge typically being more up-to-date, and package dependencies preferring open-source dependencies. Both of these reasons are why we recommend conda-forge over defaults.</p><p>You will likely need a bioconda package at some point in your life, so you'll want to add the bioconda channel too:</p><pre>micromamba config prepend channels bioconda</pre><p>The “prepend” subcommand ensures that the channel added is “prepended” to the list of channels (i.e., top of the list), so is the highest priority.</p><h4>Storing downloaded packages on VAST Scratch</h4><p>When micromamba installs packages, it first downloads the files in a “compressed tarball” into a cache. This is to speed up installations of the same packages in the future. However, they are not strictly necessary, as micromamba will redownload these tarballs if they no longer exist. Hence, <strong>you must have these packages stored on VAST Scratch</strong> as the automatic deletion policy will ensure unused cached packages are deleted. Read more about VAST scratch on our <a href="/sites/rc2/SitePages/Data-how-to-store.aspx">filesystems page</a>.</p><p>If you are new to Milton, request access to VAST scratch through <a href="https://support.wehi.edu.au/support/catalog/items/71">this form</a>.</p><p>To set micromamba to install packages to VAST scratch, execute the following commands</p><pre>$ micromamba config append pkgs_dirs /vast/scratch/users/$USER/condapkgs</pre><p>Confirm that this configuration has been set correctly with</p><pre>$ micromamba config get pkgs_dirs</pre><pre>pkgs_dirs:<br>  - /vast/scratch/users/yang.e/condapkgs</pre><p>OR check the ~/.condarc configuration file that should now exist:</p><pre>$ cat ~/.condarc</pre><pre>pkgs_dirs:<br> - /vast/scratch/users/yang.e/condapkgs</pre><h4>Storing your environments</h4><p>Generally, <span class="fontColorBlue">conda</span> environments are reproducible, hence we usually recommend that you place environments on VAST scratch as well. However, given that some environments are used frequently and/or difficult to put back together, this is more of a <i>suggestion</i>. The main benefit to putting your environments on VAST scratch is that you avoid filling up your home directory with environments. But of course, if an environment goes unused, the environment will be deleted by the auto-deletion policy on VAST scratch.&nbsp;</p><p style="margin-left:0px;">Choosing where to save your environment, is a bit tricky. We have set the following questions to help you choose the locations.</p><ul><li><strong>Is it a <u>small environment</u>, that you commonly use or use across multiple projects?</strong><ul><li><i><strong>Research Computing recommends storing your environment in your </strong><span class="fontColorBlue"><strong>HOME.</strong></span></i></li><li><span class="fontColorRed"><strong>In this case, you need to remove environments not used any more, to free up space.</strong></span></li></ul></li><li><strong>Is it a <u>temporary</u> or <u>test environment</u>?</strong><ul><li><i><strong>Research Computing recommends storing your environment in your </strong></i><span class="fontColorBlue"><strong>VAST Scratch area</strong></span><strong>.&nbsp;</strong></li></ul></li><li><strong>Is it related to a <u>specific project</u>?</strong><ul><li><i><strong>Research Computing recommends storing your environment in your </strong></i><span class="fontColorBlue"><strong>VAST Project area</strong></span><strong>.&nbsp;</strong></li></ul></li></ul><p><strong>Stornext/NAS (e.g., lab shares) is the </strong><i><strong>least</strong></i><strong> preferred place to store conda environments as environments </strong><span class="fontColorBlue"><strong>do not need to be backed up or archived to tape.</strong></span><br>&nbsp;</p><p>To set this up:</p><pre>$ micromamba config append envs_dirs /vast/scratch/users/$USER/condaenvs</pre><p>And confirm that the configuration was set correctly:</p><pre>$ micromamba config get envs_dirs<br>envs_dirs:<br>  - /vast/scratch/users/yang.e/condaenvs</pre><p>Some exceptions to this advice do apply. For example, if you have a VAST project that a new environment will be used for, we generally recommend that the environment is put there instead.</p><p>Note: When using a custom env directory the full path to the env will be displayed in your command prompt. To display only the env name run this command to update your .condarc file:</p><pre><span style="font-size:inherit;">$ micromamba config set env_prompt "({name}) "</span></pre><p>This should change your prompt when activating a env:</p><pre>$ micromamba activate myenv<br>#Long prompt<br>(/vast/scratch/users/yang.e/condaenvs/myenv) $ <br>#Short prompt<br>(myenv) $</pre>
<h2>Creating and Activating Environments</h2><p>We recommend that you explicitly specify where your conda environments will be stored every time you create them. This is partially due to the limited space on home directories, but also to ensure that environments are kept close to related files. It also makes them easier to share.</p><p>To create an environment:</p><pre>$ micromamba create -p /vast/scratch/users/$USER/myenv python pandas ...</pre><p>Before activating your environment, you will need to setup your shell:</p><pre>$ micromamba shell init --shell bash --root-prefix=~/micromamba<br>Modifying RC file "/home/users/allstaff/yang.e/.bashrc"<br>Generating config for root prefix "/stornext/Home/data/allstaff/y/yang.e/micromamba"<br>Setting mamba executable to: "/stornext/System/data/tools/micromamba/micromamba-latest/bin/micromamba"<br>Adding (or replacing) the following in your "/home/users/allstaff/yang.e/.bashrc" file<br><br># &gt;&gt;&gt; mamba initialize &gt;&gt;&gt;<br># !! Contents within this block are managed by 'mamba init' !!<br>export MAMBA_EXE='/stornext/System/data/tools/micromamba/micromamba-latest/bin/micromamba';<br>export MAMBA_ROOT_PREFIX='/stornext/Home/data/allstaff/y/yang.e/micromamba';<br>__mamba_setup="$("$MAMBA_EXE" shell hook --shell bash --root-prefix "$MAMBA_ROOT_PREFIX" 2&gt; /dev/null)"<br>if [ $? -eq 0 ]; then<br>   eval "$__mamba_setup"<br>else<br>   alias micromamba="$MAMBA_EXE"  # Fallback on help from mamba activate<br>fi<br>unset __mamba_setup<br># &lt;&lt;&lt; mamba initialize &lt;&lt;&lt;</pre><p>This changes your ~/.bashrc file, which is used to setup your environment every time you log onto Milton. Apply the changes to your current shell by</p><pre>. ~/.bashrc</pre><p>You can then activate the environment and use your installed packages:</p><pre>$ micromamba activate /vast/scratch/users/$USER/myenv</pre><p>Once you activate your environment, you can install more packages as needed</p><pre>micromamba install r r-base ...</pre><p>If you have installed Python, you can also install packages with pip</p><pre>pip install scipy ...</pre><p>Or likewise with R:</p><pre>Rscript -e 'install.packages(”Matrix", repos="https://cloud.r-project.org/")'</pre><p>In both cases, packages will be stored somewhere inside the environment.</p><h4>Activating your conda environments inside a Slurm script</h4><p>This will require that you ran the shell inialization command mentioned before. After than, using your environment inside your Slurm scripts requires that you load the appropriate software module, and then execute the environment activation command. After the activation command, you should be able to use the packages installed therein.</p><pre>#SBATCH stuff<br><br># initialize micromamba inside the script<br>. “$MAMBA_ROOT_PREFIX/etc/profile.d/micromamba.sh”<br><br>micromamba activate &lt;your environment&gt;<br><br>&lt;rest of your script using the environment&gt;</pre><p>Remember to activate your environment <i>after</i> you've declared your #SBATCH options.</p>
<h2>Managing Packages</h2><p>Besides installing packages, at some point, you probably will want to update/downgrade or remove packages from your environment.&nbsp;</p><h3>Update a package</h3><pre>micromamba update &lt;package&gt;</pre><p>This updates the package to the newest available and allowable version. You can update the package to a specific version with the equals qualifier. For example, upgrading pandas to v2.0.1:</p><pre>micromamba update pandas=2.0.1</pre><p>You can also use other comparison operations like less-than ("&lt;"), greater than ("&gt;"), but remember to wrap the package in quotes, otherwise the shell will interpret these characters as redirections e.g.,</p><pre>micromamba update ‘pandas&lt;2’</pre><p>Update all packages with</p><pre>micromamba update --all</pre><h3>Remove a package</h3><pre>micromamba remove &lt;package&gt;</pre><p>This will remove the package you specify <strong>as well as any dependencies and dependants</strong>. It's important you double-check the package(s) you are removing are only taking away the packages you don't need.</p><h3>See which packages are installed</h3><pre>micromamba list</pre><p>This will list all the packages installed in the current environment, including automatically installed dependencies. Packages that you installed explicitly will be highlighted.&nbsp;</p><p>Note that packages installed with R or pip will not show up in this list. To see pip packages installed, run:</p><pre>pip list</pre><p>Similarly for R:</p><pre>Rscript -e “installed.packages()”</pre><h3>Cleaning package cache</h3><p>As part of the installation process, micromamba/conda will download installation files and cache them in case you need them again. These are stored in the pkgs_dir which was configured above. Clean out this cache with</p><pre>micromamba clean --all</pre><p>This will delete unused packages and downloaded files.</p>
<h2>Managing Environments</h2><p>In your use of conda/micromamba, you will inevitably have many environments which you need to keep manage. Below are some commmands you can use to do this.</p><h3>Creating environments</h3><pre>micromamba create -p /path/to/your/env &lt;packages&gt; ...</pre><p>This creates an environment at the location /path/to/your/env</p><pre>micromamba create -n your-env &lt;packages&gt; ...</pre><p>This creates an environment in your envs_dirs directory (as specified in your ~/.condarc file, which is your home directory by default).&nbsp;</p><p>Our recommended approach is to use the -p method.</p><h3>Creating environments from YAML files</h3><p>When running others' software, it is not uncommon to be given an environment.yaml file, which is used to specify the conda packages needed to run the software. The command to do this is <i>slightly</i> different from the create commands above</p><pre>micromamba env create -f &lt;environment.yaml&gt;</pre><p>This command alone will create an environment in your envs_dirs directory with a name determined by the name: directive in the yaml file. To override the name you can supply your own name with -n and -p e.g.,&nbsp;</p><pre>micromamba env create -f environment.yaml -p /path/to/your/env</pre><p>Will create an environment in /path/to/your/env instead of using the name specified in the yaml file.</p><h3>Removing environments</h3><p>In general, you can use the in built command with either the -n and -p flat to specify which environment to remove</p><pre>micromamba env remove -p /path/to/your/env<br>micromamba env remove -n myenv</pre><p>More conveniently, you can simply delete the environment</p><pre>rm -rf /path/to/your/env<br>rm -rf /your/envs_dirs/myenv</pre><p>Using the in-built command is generally recommended.</p><h3>Copying/sharing environments</h3><p><i>Sometimes</i>, environments are relocatable. This means you may be able to simply</p><pre>cp -r /path/to/your/env /new/path/to/env</pre><p>However, this isn't always guaranteed to work, depending on the package installation recipes. Instead we recommend creating a yml file with the list of packages. With your environment activated:</p><pre>micromamba export &gt; environment.yml</pre><p>“micromamba export” prints a list of the packages installed by micromamba/conda and redirects that output to the “environment.yml” file in the current directory. If you've installed packages with pip, you should also run</p><pre>pip freeze &gt; requirements.txt</pre><p>Which does something similar, but for pip-installed packages only, You can then recreate the environment by</p><pre># create new environment at new location<br>micromamba env create -p /new/path/to/env -f environment.yml<br><br># deactivate current environment<br>micromamba deactivate<br><br># activate new environment<br>micromamba activate /new/path/to/env<br><br># install pip packages in new environment<br>pip install -r requirements.txt</pre><p>The environment.yml and requirements.txt files can be given to your colleagues and they should also be able to recreate your environment. You can delete the old environment if necessary.</p>
